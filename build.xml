<?xml version="1.0"?>

<project name="CADET" default="setup-database" basedir="." description="This is the buildfile used for building temporary Drupal environments.">
    <!-- General properties -->
    <property name="drupal.install.dir" value="/var/lib/drupal"/>
    <property name="drupal.version" value="7.24" />
    <property name="domain" value="cadet.captest.be"/>
    <property name="docroot" value="/var/www/cadet"/>
    <property name="mysql.suser" value="su"/>
    <property name="mysql.supassword" value="pass"/>

    <target name="debug">
        <exec command="ls ${drupal.install.dir} | sort -r | head -1" outputProperty="drupal.latest.version"/>
        <if>
            <equals arg1="${drupal.version}" arg2="" />
            <then>
                <property name="drupal.directory" value="${drupal.install.dir}/${drupal.latest.version}"/>
                <echo>No Drupal version speicified. The latest available version, found on this server, will be used. (${drupal.directory})</echo>
            </then>
            <else>
                <property name="drupal.directory" value="${drupal.install.dir}/drupal-${drupal.version}"/>
                <if>
                    <available file="${drupal.directory}" type="dir"/>
                    <then>
                        <echo>Drupal ${drupal.version} is available on the server.</echo>
                    </then>
                    <else>
                        <echo>Drupal ${drupal.version} is not available on the server. Starting download.</echo>
                        <phingcall target="drush-download"/>
                    </else>
                </if>
            </else>
        </if>
        <php expression="substr(str_shuffle(abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ),0, 1) . substr(str_shuffle(aBcEeFgHiJkLmNoPqRstUvWxYz0123456789),0, 8)" returnProperty="instance.name"/>
        <echo>Setting up a temporary Drupal environment</echo>
        <!--<phingcall target="setup-docroot"/>-->
        <phingcall target="setup-database"/>
    </target>

    <target name="setup-database">
        <pdo url="mysql:host=localhost" encoding="utf8" userId="${mysql.suser}" password="${mysql.supassword}" onerror="abort">
            CREATE DATABASE CADET${instance.name};
            GRANT ALL ON CADET${instance.name}.* to ${instance.name}@localhost IDENTIFIED BY '${instance.dbpassword}';
        </pdo>
    </target>

    <target name="setup-docroot">
        <property name="instance.domain" value="${instance.name}.${domain}" />
        <property name="instance.docroot" value="${docroot}/${instance.name}" />
        <echo>${instance.docroot}</echo>
        <copy todir="${instance.docroot}">
            <fileset dir="${drupal.directory}">
            </fileset>
        </copy>
        <chown file="${instance.docroot}" user="nobody" group="nogroup" />
        <copy file="virtualhost.conf" tofile="/etc/apache2/site-available/CADET-${instance.name}" overwrite="true">
            <filterchain>
                <replaceregexp>
                    <regexp pattern="####" replace="${instance.domain}" ignoreCase="true" />
                    <regexp pattern="@@@@" replace="${instance.docroot}" ignoreCase="true" />
                </replaceregexp>
            </filterchain>
        </copy>
        <exec command="a2ensite CADET-${instance.name}" />
        <exec command="service apache2 reload" />
    </target>

    <target name="drush-download" depends="drush-init">
        <drush command="dl" assume="yes">
            <option name="destination">${drupal.install.dir}</option>
            <param>drupal-${drupal.version}</param>
        </drush>
    </target>

    <target name="drush-init">
        <taskdef name="drush" classname="DrushTask" />
    </target>
</project>